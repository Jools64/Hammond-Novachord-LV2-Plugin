#define WAVE_TABLE_LENGTH 800
double waveTable[] = {-0.8428571428571429, -0.8428571428571429, -0.8464285714285714, -0.8464285714285714, -0.8464285714285714, -0.8464285714285714, -0.85, -0.85, -0.85, -0.85, -0.8535714285714285, -0.8535714285714285, -0.8535714285714285, -0.8535714285714285, -0.8571428571428571, -0.8571428571428571, -0.8571428571428571, -0.8571428571428571, -0.8571428571428571, -0.8571428571428571, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8642857142857143, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8607142857142858, -0.8571428571428571, -0.8571428571428571, -0.8571428571428571, -0.8571428571428571, -0.8535714285714285, -0.8535714285714285, -0.8535714285714285, -0.8535714285714285, -0.85, -0.85, -0.85, -0.8464285714285714, -0.8464285714285714, -0.8428571428571429, -0.8428571428571429, -0.8428571428571429, -0.8392857142857143, -0.8392857142857143, -0.8357142857142857, -0.8357142857142857, -0.8321428571428572, -0.8321428571428572, -0.8285714285714286, -0.8285714285714286, -0.825, -0.825, -0.8214285714285714, -0.8214285714285714, -0.8178571428571428, -0.8178571428571428, -0.8142857142857143, -0.8142857142857143, -0.8107142857142857, -0.8071428571428572, -0.8071428571428572, -0.8035714285714286, -0.8035714285714286, -0.8, -0.7964285714285714, -0.7928571428571428, -0.7892857142857143, -0.7857142857142857, -0.7821428571428571, -0.7785714285714286, -0.775, -0.7714285714285715, -0.7678571428571429, -0.7642857142857142, -0.7607142857142857, -0.7571428571428571, -0.7535714285714286, -0.75, -0.7464285714285714, -0.7428571428571429, -0.7392857142857143, -0.7357142857142858, -0.7321428571428571, -0.7285714285714285, -0.725, -0.7214285714285714, -0.7178571428571429, -0.7142857142857143, -0.7071428571428572, -0.7035714285714286, -0.7, -0.6928571428571428, -0.6892857142857143, -0.6857142857142857, -0.6785714285714286, -0.675, -0.6714285714285714, -0.6642857142857143, -0.6607142857142857, -0.6535714285714286, -0.65, -0.6428571428571429, -0.6392857142857142, -0.6357142857142857, -0.6285714285714286, -0.625, -0.6178571428571429, -0.6142857142857143, -0.6071428571428571, -0.6035714285714285, -0.6, -0.5928571428571429, -0.5892857142857143, -0.5857142857142857, -0.5785714285714286, -0.575, -0.5714285714285714, -0.5642857142857143, -0.5607142857142857, -0.5571428571428572, -0.55, -0.5464285714285714, -0.5428571428571428, -0.5357142857142857, -0.5321428571428571, -0.5285714285714286, -0.5214285714285715, -0.5178571428571429, -0.5142857142857142, -0.5071428571428571, -0.5035714285714286, -0.5, -0.4928571428571429, -0.48928571428571427, -0.4857142857142857, -0.4785714285714286, -0.475, -0.4714285714285714, -0.4642857142857143, -0.4607142857142857, -0.45714285714285713, -0.45, -0.44642857142857145, -0.44285714285714284, -0.4357142857142857, -0.43214285714285716, -0.42857142857142855, -0.42142857142857143, -0.41785714285714287, -0.4142857142857143, -0.40714285714285714, -0.4035714285714286, -0.4, -0.39285714285714285, -0.3892857142857143, -0.38571428571428573, -0.37857142857142856, -0.375, -0.37142857142857144, -0.36428571428571427, -0.3607142857142857, -0.35714285714285715, -0.35, -0.3464285714285714, -0.34285714285714286, -0.3357142857142857, -0.33214285714285713, -0.32857142857142857, -0.32142857142857145, -0.31785714285714284, -0.3142857142857143, -0.30714285714285716, -0.30357142857142855, -0.3, -0.29285714285714287, -0.2892857142857143, -0.2857142857142857, -0.2785714285714286, -0.275, -0.26785714285714285, -0.2642857142857143, -0.26071428571428573, -0.25357142857142856, -0.25, -0.24285714285714285, -0.2392857142857143, -0.23214285714285715, -0.22857142857142856, -0.225, -0.21785714285714286, -0.21428571428571427, -0.20714285714285716, -0.20357142857142857, -0.2, -0.19285714285714287, -0.18928571428571428, -0.18214285714285713, -0.17857142857142858, -0.17142857142857143, -0.16785714285714284, -0.16428571428571428, -0.15714285714285714, -0.15357142857142858, -0.15, -0.14285714285714285, -0.1392857142857143, -0.1357142857142857, -0.13214285714285715, -0.12857142857142856, -0.125, -0.12142857142857143, -0.11785714285714285, -0.11785714285714285, -0.11428571428571428, -0.11428571428571428, -0.11071428571428571, -0.11071428571428571, -0.10714285714285714, -0.10714285714285714, -0.10357142857142858, -0.10357142857142858, -0.1, -0.1, -0.1, -0.09642857142857143, -0.09642857142857143, -0.09642857142857143, -0.09642857142857143, -0.09642857142857143, -0.09285714285714286, -0.09285714285714286, -0.09285714285714286, -0.09285714285714286, -0.09285714285714286, -0.09285714285714286, -0.09285714285714286, -0.09285714285714286, -0.09285714285714286, -0.09285714285714286, -0.09642857142857143, -0.09642857142857143, -0.09642857142857143, -0.1, -0.1, -0.10357142857142858, -0.10714285714285714, -0.11428571428571428, -0.11785714285714285, -0.125, -0.12857142857142856, -0.13214285714285715, -0.1392857142857143, -0.14285714285714285, -0.14642857142857144, -0.15, -0.15, -0.15357142857142858, -0.15357142857142858, -0.15357142857142858, -0.15357142857142858, -0.15357142857142858, -0.15357142857142858, -0.15357142857142858, -0.15357142857142858, -0.15, -0.15, -0.14642857142857144, -0.14285714285714285, -0.1392857142857143, -0.1357142857142857, -0.13214285714285715, -0.12857142857142856, -0.12142857142857143, -0.11785714285714285, -0.11428571428571428, -0.11071428571428571, -0.10714285714285714, -0.10357142857142858, -0.09642857142857143, -0.09285714285714286, -0.08571428571428572, -0.08214285714285714, -0.075, -0.07142857142857142, -0.06428571428571428, -0.060714285714285714, -0.05357142857142857, -0.05, -0.04285714285714286, -0.03571428571428571, -0.03214285714285714, -0.025, -0.02142857142857143, -0.014285714285714285, -0.007142857142857143, -0.0035714285714285713, 0.0035714285714285713, 0.007142857142857143, 0.014285714285714285, 0.017857142857142856, 0.02142857142857143, 0.02857142857142857, 0.03214285714285714, 0.039285714285714285, 0.04285714285714286, 0.05, 0.05357142857142857, 0.05714285714285714, 0.06428571428571428, 0.06785714285714285, 0.075, 0.07857142857142857, 0.08571428571428572, 0.08928571428571429, 0.09642857142857143, 0.1, 0.10714285714285714, 0.11071428571428571, 0.11785714285714285, 0.12142857142857143, 0.12857142857142856, 0.13214285714285715, 0.1357142857142857, 0.14285714285714285, 0.14642857142857144, 0.15, 0.15357142857142858, 0.16071428571428573, 0.16428571428571428, 0.16785714285714284, 0.17142857142857143, 0.175, 0.18214285714285713, 0.18571428571428572, 0.18928571428571428, 0.19285714285714287, 0.2, 0.20357142857142857, 0.20714285714285716, 0.21071428571428572, 0.21785714285714286, 0.22142857142857142, 0.225, 0.23214285714285715, 0.2357142857142857, 0.2392857142857143, 0.24642857142857144, 0.25, 0.25357142857142856, 0.26071428571428573, 0.2642857142857143, 0.26785714285714285, 0.2714285714285714, 0.275, 0.2785714285714286, 0.28214285714285714, 0.2857142857142857, 0.2892857142857143, 0.29285714285714287, 0.29642857142857143, 0.3, 0.30357142857142855, 0.30714285714285716, 0.3107142857142857, 0.3142857142857143, 0.31785714285714284, 0.32142857142857145, 0.325, 0.32857142857142857, 0.33214285714285713, 0.3392857142857143, 0.34285714285714286, 0.3464285714285714, 0.35, 0.3535714285714286, 0.35714285714285715, 0.3607142857142857, 0.36428571428571427, 0.3678571428571429, 0.37142857142857144, 0.375, 0.37857142857142856, 0.3821428571428571, 0.38571428571428573, 0.3892857142857143, 0.39285714285714285, 0.3964285714285714, 0.4, 0.4035714285714286, 0.40714285714285714, 0.4107142857142857, 0.4142857142857143, 0.41785714285714287, 0.42142857142857143, 0.425, 0.42857142857142855, 0.43214285714285716, 0.4357142857142857, 0.4392857142857143, 0.44285714285714284, 0.44642857142857145, 0.45, 0.45357142857142857, 0.45714285714285713, 0.4607142857142857, 0.4642857142857143, 0.46785714285714286, 0.4714285714285714, 0.475, 0.4785714285714286, 0.48214285714285715, 0.4857142857142857, 0.48928571428571427, 0.4928571428571429, 0.49642857142857144, 0.5, 0.5, 0.5035714285714286, 0.5071428571428571, 0.5107142857142857, 0.5142857142857142, 0.5178571428571429, 0.5214285714285715, 0.525, 0.5285714285714286, 0.5321428571428571, 0.5357142857142857, 0.5392857142857143, 0.5428571428571428, 0.5464285714285714, 0.55, 0.5535714285714286, 0.5571428571428572, 0.5607142857142857, 0.5642857142857143, 0.5678571428571428, 0.5714285714285714, 0.575, 0.5785714285714286, 0.5821428571428572, 0.5857142857142857, 0.5892857142857143, 0.5928571428571429, 0.5964285714285714, 0.6, 0.6035714285714285, 0.6035714285714285, 0.6071428571428571, 0.6107142857142858, 0.6142857142857143, 0.6178571428571429, 0.6214285714285714, 0.625, 0.625, 0.6285714285714286, 0.6321428571428571, 0.6357142857142857, 0.6392857142857142, 0.6428571428571429, 0.6464285714285715, 0.6464285714285715, 0.65, 0.6535714285714286, 0.6571428571428571, 0.6607142857142857, 0.6642857142857143, 0.6678571428571428, 0.6678571428571428, 0.6714285714285714, 0.675, 0.6785714285714286, 0.6821428571428572, 0.6857142857142857, 0.6892857142857143, 0.6892857142857143, 0.6928571428571428, 0.6964285714285714, 0.7, 0.7035714285714286, 0.7071428571428572, 0.7071428571428572, 0.7107142857142857, 0.7142857142857143, 0.7178571428571429, 0.7214285714285714, 0.725, 0.725, 0.7285714285714285, 0.7321428571428571, 0.7357142857142858, 0.7392857142857143, 0.7392857142857143, 0.7428571428571429, 0.7428571428571429, 0.7464285714285714, 0.7464285714285714, 0.75, 0.7535714285714286, 0.7535714285714286, 0.7571428571428571, 0.7571428571428571, 0.7607142857142857, 0.7607142857142857, 0.7642857142857142, 0.7678571428571429, 0.7678571428571429, 0.7714285714285715, 0.7714285714285715, 0.775, 0.775, 0.7785714285714286, 0.7821428571428571, 0.7821428571428571, 0.7857142857142857, 0.7857142857142857, 0.7892857142857143, 0.7892857142857143, 0.7928571428571428, 0.7928571428571428, 0.7964285714285714, 0.7964285714285714, 0.8, 0.8, 0.8035714285714286, 0.8035714285714286, 0.8071428571428572, 0.8071428571428572, 0.8107142857142857, 0.8107142857142857, 0.8142857142857143, 0.8142857142857143, 0.8178571428571428, 0.8178571428571428, 0.8214285714285714, 0.8214285714285714, 0.825, 0.825, 0.8285714285714286, 0.8285714285714286, 0.8321428571428572, 0.8321428571428572, 0.8357142857142857, 0.8357142857142857, 0.8357142857142857, 0.8392857142857143, 0.8392857142857143, 0.8428571428571429, 0.8428571428571429, 0.8464285714285714, 0.8464285714285714, 0.85, 0.85, 0.85, 0.8535714285714285, 0.8535714285714285, 0.8571428571428571, 0.8571428571428571, 0.8607142857142858, 0.8607142857142858, 0.8607142857142858, 0.8607142857142858, 0.8642857142857143, 0.8642857142857143, 0.8642857142857143, 0.8642857142857143, 0.8642857142857143, 0.8678571428571429, 0.8678571428571429, 0.8678571428571429, 0.8678571428571429, 0.8678571428571429, 0.8714285714285714, 0.8714285714285714, 0.8714285714285714, 0.8714285714285714, 0.8714285714285714, 0.8714285714285714, 0.875, 0.875, 0.875, 0.875, 0.875, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.8785714285714286, 0.875, 0.875, 0.875, 0.875, 0.8714285714285714, 0.8714285714285714, 0.8714285714285714, 0.8678571428571429, 0.8678571428571429, 0.8678571428571429, 0.8678571428571429, 0.8642857142857143, 0.8642857142857143, 0.8607142857142858, 0.8571428571428571, 0.8535714285714285, 0.85, 0.8464285714285714, 0.8392857142857143, 0.8285714285714286, 0.8178571428571428, 0.8071428571428572, 0.7928571428571428, 0.7821428571428571, 0.7714285714285715, 0.7607142857142857, 0.7464285714285714, 0.7321428571428571, 0.7142857142857143, 0.6964285714285714, 0.6821428571428572, 0.6642857142857143, 0.6464285714285715, 0.6321428571428571, 0.6142857142857143, 0.5928571428571429, 0.575, 0.5535714285714286, 0.5357142857142857, 0.5178571428571429, 0.49642857142857144, 0.4785714285714286, 0.45714285714285713, 0.4392857142857143, 0.41785714285714287, 0.4, 0.37857142857142856, 0.3607142857142857, 0.34285714285714286, 0.32142857142857145, 0.30357142857142855, 0.28214285714285714, 0.2642857142857143, 0.24642857142857144, 0.23214285714285715, 0.21428571428571427, 0.19642857142857142, 0.17857142857142858, 0.16428571428571428, 0.14642857142857144, 0.12857142857142856, 0.11071428571428571, 0.09285714285714286, 0.07857142857142857, 0.060714285714285714, 0.04285714285714286, 0.025, 0.010714285714285714, -0.007142857142857143, -0.025, -0.04642857142857143, -0.06785714285714285, -0.08928571428571429, -0.11071428571428571, -0.13214285714285715, -0.15, -0.17142857142857143, -0.19285714285714287, -0.21428571428571427, -0.2357142857142857, -0.2571428571428571, -0.275, -0.29642857142857143, -0.3142857142857143, -0.3357142857142857, -0.3535714285714286, -0.375, -0.39285714285714285, -0.4107142857142857, -0.43214285714285716, -0.45, -0.4714285714285714, -0.48928571428571427, -0.5107142857142857, -0.5285714285714286, -0.55, -0.5678571428571428, -0.5821428571428572, -0.5964285714285714, -0.6142857142857143, -0.6285714285714286, -0.6464285714285715, -0.6607142857142857, -0.675, -0.6857142857142857, -0.6928571428571428, -0.7, -0.7071428571428572, -0.7142857142857143, -0.7178571428571429, -0.725, -0.7321428571428571, -0.7392857142857143, -0.7464285714285714, -0.7535714285714286, -0.7571428571428571, -0.7607142857142857, -0.7678571428571429, -0.7714285714285715, -0.775, -0.7785714285714286, -0.7821428571428571, -0.7892857142857143, -0.7928571428571428, -0.7964285714285714, -0.8, -0.8035714285714286, -0.8035714285714286, -0.8071428571428572, -0.8107142857142857, -0.8142857142857143, -0.8178571428571428, -0.8178571428571428, -0.8214285714285714, -0.825, -0.825, -0.8285714285714286, -0.8285714285714286, -0.8321428571428572, -0.8321428571428572, -0.8357142857142857, -0.8357142857142857, -0.8392857142857143, -0.8392857142857143, -0.8392857142857143, -0.8428571428571429, -0.8428571428571429, -0.8428571428571429};
f64 linearBlend(f64 a, f64 b, f64 amount)
{
	f64 delta = b - a;
	return a + (delta * amount);
}

f32 sampleWaveTable(f64 value, f64* waveTable, int waveTableSize)
{
	value /= PI * 2;
	value /= 2;
	f64 position = (value - floor(value)) * waveTableSize;
	
	f64 sampleA, sampleB;

	sampleA = waveTable[(int)floor(position)];
	//return sampleA;

	if((int)ceil(position) >= WAVE_TABLE_LENGTH)
		sampleB = waveTable[0];
	else 
		sampleB = waveTable[(int)ceil(position)];

	return linearBlend(sampleA, sampleB, position - floorf(position));

	//return waveTable[(int)floorf(position)];
}

// A sawtooth waveform generator to the same specification as sin
f32 saw(f32 value)
{
	value /= PI * 2;
	value -= floor(value);
	value *= 2;
	value -= 1;
	return value;
}

// A square waveform generator to the same specification as sin
f32 square(f32 value)
{
	value /= PI * 2;
	value -= floor(value);
	value = round(value);
	value *= 2;
	value -= 1;
	return value;
}

// A triangle waveform generator to the same specification as sin
f32 triangle(f32 value)
{
	return value;
}

f32 octave(f32 frequency, u32 octave)
{
	for(u32 i = 0; i < octave; ++i)
		frequency *= 2;
	return frequency;
}

typedef struct WaveSpecification
{
	f32 gain, attack, release, decay, vibratoFrequency, vibratoDepth, vibratoVariance;
	f32 sustainVolume, decayVolume;
	f32 initialEnvelopPos;
	Vibrato firstVibrato, secondVibrato;
} WaveSpecification;

f32 addVibrato(Vibrato* vibrato, f64 sampleIndex, u32 sampleRate, f32 frequency, int noteIndex)
{
    // TODO: Make vibrato range more consistent between high and low notes.

	f32 position = ((f32)sampleIndex / sampleRate) * (PI * 2);
	f32 vibratoFrequency = vibrato->frequency;
	// Simulate the six reeds
	vibratoFrequency *= 1 + (((float)((noteIndex % 12) / 2) / 6) * 0.1);

    return frequency + 
    	sin(position * vibratoFrequency) * (frequency * vibrato->depth);
}

f32 generateSample(
	Note* note, WaveSpecification* waveSpecification, 
	f64 sampleIndex, u32 sampleRate, f32* noteMap)
{
	//TODO: This should be moved out of this function
	f32 noteEndOffset = 
		note->releaseOffset + (waveSpecification->release * sampleRate);
	if(note->envelope > 0.0)
		note->playing = true;

	if(note->pressed)
	{
		if(note->sustaining)
		{
			if(note->envelope >= waveSpecification->decayVolume)
			{
				if(waveSpecification->decay == 0)
					note->envelope = waveSpecification->decayVolume;
				else
					note->envelope -= (1 / waveSpecification->decay) / sampleRate; 
			}
		}
		else
		{
			if(note->envelope < waveSpecification->initialEnvelopPos)
				note->envelope = waveSpecification->initialEnvelopPos;

			if(waveSpecification->attack != 0)
				note->envelope += ((1 / waveSpecification->attack) / sampleRate); 
			else
				note->envelope = 1;

			if(note->envelope >= waveSpecification->sustainVolume)
			{
				note->sustaining = true;
			}
		}
		
	}
	else
	{
		// If decay still exists then perform it before release
		note->sustaining = false;
		if(note->envelope >= waveSpecification->decayVolume 
			&& waveSpecification->decay != 0)
		{
			if(waveSpecification->decay == 0)
				note->envelope = waveSpecification->decayVolume;
			else
				note->envelope -= (1 / waveSpecification->decay) / sampleRate; 
		}
		else
		{
			if(waveSpecification->release != 0)
				note->envelope -= ((1 / (waveSpecification->release)) / sampleRate);
			else
				note->envelope = 0;
		}	
	}
		
	note->envelope = clamp(note->envelope, 0, 1);

	if(note->playing)
	{
	
		f32 frequency = octave(noteMap[note->index%12], note->index/12);
		if(waveSpecification->firstVibrato.enabled)
		    frequency = addVibrato(&waveSpecification->firstVibrato, sampleIndex, sampleRate, frequency, note->index);
	    if(waveSpecification->secondVibrato.enabled)
		    frequency = addVibrato(&waveSpecification->secondVibrato, sampleIndex, sampleRate, frequency, note->index);
		
		note->waveOffset += (frequency / (f32)sampleRate);
		
		f32 gainCoeficient = decibelCoeficient(waveSpecification->gain);
		
		return (f32)(sampleWaveTable(note->waveOffset * (2 * PI), waveTable, WAVE_TABLE_LENGTH) 
			* gainCoeficient * note->envelope); //* attackCoeficient * releaseCoeficient);
	}
	
	return 0;
}
